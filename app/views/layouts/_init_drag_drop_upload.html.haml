%input{id: "fileupload", style: 'display: none', type: "file", name: "asset", data: { 'url' => project_path(@project) + '/assets'} }

:javascript

  // File upload support functions

  function targetForDropEvent(e, file) {
    var dropTarget = e.delegatedEvent.target;
    var isTextArea = dropTarget.nodeName.toLowerCase() === 'textarea';
    if (isTextArea) {
      return dropTarget;
    } else {
      return null;
    }
  }

  function hasMarkdownForFile(textarea, file) {
    var pattern = '!\\[' + file.name + '\\]';
    return $(textarea).val().match(new RegExp(pattern));
  }

  function addUploadingPlaceholder(textarea, file) {
    var text = $(textarea).val();
    if (text !== '') {
      text += "\n";
    }
    var updatedText = text + "![" + file.name + "](Uploading…)"
    $(textarea).val(updatedText).trigger('input');
  }

  function replaceUploadingPlaceholder(textarea, asset) {
    var text = $(textarea).val();

    var pattern = '!\\[' + asset.original_name + '\\]\\([:a-zA-Z…]*\\)';
    var replacement = '![' + asset.original_name + '](' + asset.href + ')';
    var updatedText = text.replace(new RegExp(pattern), replacement);

    $(textarea).val(updatedText).trigger('input');
  }

  function uploadFailed(data) {
    var error = data.errorThrown;
    var message = error ? 'Upload failed: ' + error : 'Upload failed.';
    alert(message);

    removeUploadingPlaceholder(data.context.element, data.context.filename);
  }

  function removeUploadingPlaceholder(textarea, filename) {
    var text = $(textarea).val();

    var pattern = '!\\[' + filename + '\\]\\([:a-zA-Z…]*\\)';
    var updatedText = text.replace(new RegExp(pattern), '');

    $(textarea).val(updatedText).trigger('input');
  }

  // Configure the file upload plugin
  var fileUploadScope = 'body.project'; // enable drag/drop file upload on textareas of this scope

  $(fileUploadScope + ' #fileupload').fileupload({
    dataType: 'json',
    dropZone: $(document),

    submit: function(e, data) {
      var file = data.files[0];
      var uploadTarget = targetForDropEvent(e, file);
      if (uploadTarget && !hasMarkdownForFile(uploadTarget, file)) {
        data.context = {element: $(uploadTarget), filename: file.name};
        addUploadingPlaceholder(uploadTarget, file);
      }

      return !!uploadTarget;
    },

    done: function (e, data) {
      if (data.result.asset) {
        replaceUploadingPlaceholder(data.context.element, data.result.asset);
      } else {
        uploadFailed(data);
      }
    },

    fail: function(e, data) {
      uploadFailed(data);
    }
  });

  // Disable the default browser action when dropping a file on the document
  $(fileUploadScope).bind('drop dragover', function (e) {
      e.preventDefault();
  });
